import React, { useEffect, useRef, useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import dummyGyms from "../data/dummyGyms.js";


const MapComponent = () => {
    const mapRef = useRef(null);
    const circleRef = useRef(null);
    const [markers, setMarkers] = useState([]);
    const [userPos, setUserPos] = useState(null);
    const [isMapReady, setIsMapReady] = useState(false);
    const [isGeometryReady, setIsGeometryReady] = useState(false);
    const [showRadius, setShowRadius] = useState(true);
    const [radius, setRadius] = useState(1000);
    const [searchTerm, setSearchTerm] = useState("");
    const [onlyInRadius, setOnlyInRadius] = useState(false);
    const navigate = useNavigate();
    const [activeInfoWindow, setActiveInfoWindow] = useState(null);

    useEffect(() => {
        console.log("useEffect - SDK Î°úÎìú Ï≤¥ÌÅ¨");

        const existingScript = document.querySelector('script[src*="dapi.kakao.com"]');

        if (!existingScript) {
            setIsMapReady(!isMapReady)
            const script = document.createElement("script");
            script.src =
                "https://dapi.kakao.com/v2/maps/sdk.js?appkey=a7829b6eedfe1d85903c6c1e90a99606&autoload=false&libraries=services,geometry";
            script.async = true;

            script.onload = () => {
                console.log("SDK Î°úÎìú ÏôÑÎ£å - Ï¥àÍ∏∞Ìôî ÏãúÏûë");
                window.kakao.maps.load(() => {
                    initMap();
                    setIsGeometryReady(!!window.kakao.maps.geometry?.spherical);
                }, 1000);    // 100ms ÎßåÌÅº ÏßÄÏó∞ ÏãúÌÇ®Îã§.
            };

            document.head.appendChild(script);
            console.log("ÏÉàÎ°úÏö¥ SDK Î°úÎî© ÏôÑÎ£å");
        } else {
            if (window.kakao && window.kakao.maps) {
                console.log("Ïù¥ÎØ∏ SDK Î°úÎìúÎê®");
                initMap();
            } else {
                const intervalId = setInterval(() => {
                    if (window.kakao && window.kakao.maps) {
                        initMap();
                        clearInterval(intervalId);
                    }
                }, 1000);
                console.log("Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë...");
            }
        }
    }, [isMapReady]);

    // üìå ÏßÄÎèÑ Î∞è ÏÇ¨Ïö©Ïûê ÏúÑÏπò Ï¥àÍ∏∞Ìôî
    const initMap = () => {
        console.log("initMap Ìò∏Ï∂ú");

        const container = document.getElementById("map");
        if (!container) {
            console.warn("ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
        } else {
            const savedPosition = localStorage.getItem("userPosition");
            const initialPosition = savedPosition
                ? JSON.parse(savedPosition)
                : { lat: 37.5665, lng: 126.978 };

            console.log("Ï¥àÍ∏∞ ÏúÑÏπò:", initialPosition);

            const map = new window.kakao.maps.Map(container, {
                center: new window.kakao.maps.LatLng(initialPosition.lat, initialPosition.lng),
                level: 4,
            });
            mapRef.current = map;

            if (navigator.geolocation) {
                console.log("ÏúÑÏπò Í∂åÌïú ÏöîÏ≤≠");
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        console.log("ÏÇ¨Ïö©Ïûê ÏúÑÏπò:", pos.coords);
                        const loc = new window.kakao.maps.LatLng(
                            pos.coords.latitude,
                            pos.coords.longitude
                        );
                        setUserPos(loc);
                        map.setCenter(loc);

                        new window.kakao.maps.Marker({
                            map,
                            position: loc,
                            title: "ÎÇ¥ ÏúÑÏπò",
                            image: new window.kakao.maps.MarkerImage(
                                "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
                                new window.kakao.maps.Size(24, 35)
                            ),
                        });

                        localStorage.setItem("userPosition", JSON.stringify({ lat: pos.coords.latitude, lng: pos.coords.longitude }));
                    },
                    (err) => {
                        console.warn("üö´ ÏúÑÏπò Í∂åÌïú Í±∞Î∂Ä:", err);
                    }
                );
            }
            setIsMapReady(true);
            console.log("ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
        }
    };

    // üìå Î∞òÍ≤Ω Ïõê Î†åÎçîÎßÅ
    useEffect(() => {
        console.log("useEffect - Î∞òÍ≤Ω Ïõê Î†åÎçîÎßÅ");

        if (userPos && mapRef.current) {
            console.log("ÏÇ¨Ïö©Ïûê ÏúÑÏπò:", userPos);

            if (circleRef.current) circleRef.current.setMap(null);
            if (showRadius) {
                circleRef.current = new window.kakao.maps.Circle({
                    center: userPos,
                    radius: radius,
                    strokeWeight: 2,
                    strokeColor: "#3F75FF",
                    strokeOpacity: 0.8,
                    fillColor: "#3F75FF",
                    fillOpacity: 0.2,
                    map: mapRef.current,
                });
                console.log("Î∞òÍ≤Ω Ïõê ÌëúÏãúÎê®");
            }
        }
    }, [userPos, showRadius, radius]);

    const filteredGyms = useMemo(() => {
        console.log("useMemo - Ìó¨Ïä§Ïû• ÌïÑÌÑ∞ÎßÅ Ïã§Ìñâ");

        if (!isMapReady || !mapRef.current || (onlyInRadius && !userPos)) {
            console.log("Ï°∞Í±¥ ÎØ∏Ï∂©Ï°± - ÌïÑÌÑ∞ÎßÅ Ï§ëÎã®");
            return [];
        }

        return dummyGyms.filter((gym) => {
            const matchesSearch = gym.name.toLowerCase().includes(searchTerm.toLowerCase());

            if (onlyInRadius) {
                if (!window.kakao.maps.geometry?.spherical) {
                    console.warn("geometry ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎØ∏ÏÇ¨Ïö©");
                    return false;
                }

                const gymPos = new window.kakao.maps.LatLng(gym.lat, gym.lng);
                const distance = window.kakao.maps.geometry.spherical.computeDistanceBetween(userPos, gymPos);
                const isInRadius = distance <= radius;
                console.log(`Ìó¨Ïä§Ïû•: ${gym.name}, Í±∞Î¶¨: ${distance}, Î∞òÍ≤Ω ÎÇ¥: ${isInRadius}`);
                return matchesSearch && isInRadius;
            }

            return matchesSearch;
        });
    }, [searchTerm, userPos, onlyInRadius, radius, isMapReady, isGeometryReady]);


    useEffect(() => {
        console.log("useEffect - ÌïÑÌÑ∞ÎßÅÎêú ÎßàÏª§ Î†åÎçîÎßÅ");

        if (!mapRef.current || !isMapReady) {
            console.log("ÏßÄÎèÑ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏùå");
            return;
        }

        markers.forEach((marker) => marker.setMap(null));

        const newMarkers = filteredGyms.map((gym) => {
            const position = new window.kakao.maps.LatLng(gym.lat, gym.lng);
            const marker = new window.kakao.maps.Marker({
                map: mapRef.current,
                position,
                title: gym.name,
            });

            const infoWindow = new window.kakao.maps.InfoWindow({
                content: `
              <div style="padding:5px; font-size:13px;">
                <strong>${gym.name}</strong><br/>
                <a href="/gyms/${gym.gymNo}" style="color:blue;">ÏÉÅÏÑ∏ Î≥¥Í∏∞</a>
              </div>
            `,
            });

            window.kakao.maps.event.addListener(marker, "click", () => {
                if (activeInfoWindow) {
                    activeInfoWindow.close();
                }

                infoWindow.open(mapRef.current, marker);
                setActiveInfoWindow(infoWindow);
            });

            return marker;
        });

        setMarkers(newMarkers);
        console.log("ÏÉàÎ°úÏö¥ ÎßàÏª§ Ï∂îÍ∞ÄÎê®");
    }, [filteredGyms, isMapReady]);

    const handleResetCenter = () => {
        console.log("ÎÇ¥ ÏúÑÏπòÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ ÌÅ¥Î¶≠");
        if (userPos) mapRef.current?.setCenter(userPos);
    };

    const handleToggleRadius = () => {
        console.log("Î∞òÍ≤Ω ÌëúÏãú ÌÜ†Í∏Ä");
        setShowRadius((prev) => !prev);
    };

    const handleRadiusChange = (e) => {
        const newRadius = Math.max(Number(e.target.value), 10);
        console.log("Î∞òÍ≤Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω:", newRadius);
        setRadius(newRadius);
    };


    return (
        <div style={{ position: "relative", width: "100%", height: "100vh", fontFamily: "sans-serif" }}>
            <div style={{
                position: "absolute", top: "12px", left: "50%", transform: "translateX(-50%)",
                zIndex: 10, width: "260px",
            }}>
                <div style={{ position: "relative", width: "100%" }}>
                    <input
                        type="text"
                        placeholder="Ìó¨Ïä§Ïû• Í≤ÄÏÉâ"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        style={{
                            width: "100%", padding: "8px 32px 8px 12px",
                            borderRadius: "8px", border: "1px solid #ccc",
                            boxShadow: "0 1px 4px rgba(0,0,0,0.1)",
                            fontSize: "14px", backgroundColor: "white",
                        }}
                    />
                    {searchTerm && (
                        <button
                            onClick={() => setSearchTerm("")}
                            style={{
                                position: "absolute", top: "50%", right: "8px",
                                transform: "translateY(-50%)", border: "none",
                                background: "none", cursor: "pointer", fontSize: "14px", color: "#888"
                            }}
                        >
                            ‚ùå
                        </button>
                    )}
                </div>
            </div>

            <div id="map" style={{ width: "100%", height: "100%" }}></div>

            <div style={{
                position: "absolute", top: 70, left: 10, zIndex: 10,
                backgroundColor: "white", padding: "12px", borderRadius: "10px",
                boxShadow: "0 2px 6px rgba(0,0,0,0.2)", fontSize: "14px", width: "200px"
            }}>
                <button onClick={handleResetCenter} style={{ marginBottom: "10px", width: "100%" }}>
                    üìç ÎÇ¥ ÏúÑÏπòÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
                <button onClick={handleToggleRadius} style={{ marginBottom: "10px", width: "100%" }}>
                    {showRadius ? "Î∞òÍ≤Ω Ïà®Í∏∞Í∏∞" : "Î∞òÍ≤Ω ÌëúÏãú"}
                </button>
                <div style={{ display: "flex", alignItems: "center" }}>
                    <input
                        type="number"
                        value={radius}
                        onChange={handleRadiusChange}
                        min={10}
                        step={10}
                        onFocus={(e) => e.target.style.borderColor = '#3498db'}
                        onBlur={(e) => e.target.style.borderColor = '#fff'}
                        style={{
                            width: "80%",
                            padding: "6px",
                            fontSize: "14px",
                            textAlign: "center",
                            border: "2px solid #fff",
                            borderRadius: "4px",
                            outline: "none",
                            transition: "border-color 0.3s ease-in-out",
                            WebkitAppearance: "none",
                            MozAppearance: "textfield",
                        }}
                    />
                    <span style={{ marginLeft: "5px" }}>m</span>
                </div>
            </div>

            <div style={{
                position: "absolute", bottom: 0, left: 0, width: "100%",
                maxHeight: "22vh", overflowX: "auto", display: "flex",
                backgroundColor: "#f8f8f8", padding: "10px 12px",
                boxShadow: "0 -2px 6px rgba(0,0,0,0.2)", zIndex: 5, gap: "12px"
            }}>
                {filteredGyms.map((gym) => (
                    <div
                        key={gym.gymNo}
                        onClick={() => navigate(`/gyms/${gym.gymNo}`)}
                        style={{
                            minWidth: "200px", padding: "10px", border: "1px solid #ccc",
                            borderRadius: "8px", cursor: "pointer", backgroundColor: "#fff"
                        }}
                    >
                        <strong>{gym.name}</strong>
                        <p style={{ margin: "4px 0", fontSize: "0.9em" }}>{gym.address}</p>
                        <p style={{ margin: "0", fontSize: "0.8em", color: "#888" }}>
                            ({gym.lat.toFixed(4)}, {gym.lng.toFixed(4)})
                        </p>
                    </div>
                ))}
            </div>
        </div>
    );
}

export default MapComponent;